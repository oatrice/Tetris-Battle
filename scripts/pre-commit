#!/bin/sh
# Pre-commit Hook for Tetris Battle
echo "Running Pre-commit Tests..."
BUILD_DIR="client/build"

if [ ! -d "$BUILD_DIR" ]; then
    echo "âŒ Build directory not found! Please build the project first."
    exit 1
fi

cd "$BUILD_DIR"

# Ensure Makefile is up to date
if ! cmake .. -DCMAKE_POLICY_VERSION_MINIMUM=3.5 > /dev/null 2>&1; then
    echo "âš ï¸  CMake configuration failed. Retrying with clean build..."
    rm -rf CMakeCache.txt CMakeFiles
    if ! cmake .. -DCMAKE_POLICY_VERSION_MINIMUM=3.5; then
        echo "âŒ CMake configuration failed again!"
        exit 1
    fi
fi

echo "ğŸ”¨ Building tests..."
make test_tetris > /dev/null
if [ $? -ne 0 ]; then
    echo "âŒ Build Failed! Fix compilation errors before committing."
    exit 1
fi

echo "ğŸ§ª Running gtest..."
./test_tetris
if [ $? -ne 0 ]; then
    echo "âŒ Tests Failed! Commit rejected."
    exit 1
else
    echo "âœ… Tests Passed!"
    exit 0
fi

#!/bin/sh
# Pre-commit Hook for Tetris Battle

# ============ Go Server Tests ============
echo "ğŸ” Checking Go Server..."

# Check if go.mod exists (indicates Go project)
if [ -f "go.mod" ]; then
    echo "ğŸ§ª Running Go Server Tests..."
    go test -v ./...
    GO_RESULT=$?
    if [ $GO_RESULT -ne 0 ]; then
        echo "âŒ Go Server Tests Failed!"
        exit 1
    fi
    echo "âœ… Go Server Tests Passed!"
else
    echo "âš ï¸ Warning: go.mod not found. Skipping Go tests."
fi

# ============ TypeScript Client ============
# TypeScript Client Directory
TS_DIR="client-nuxt"

# Check if directory exists relative to repo root
if [ -d "$TS_DIR" ]; then
    echo "ğŸ” Checking TypeScript Client in $TS_DIR..."
    
    # Run in subshell
    (
        cd "$TS_DIR"
        
        # 1. Run Tests
        echo "ğŸ§ª Running Tests..."
        npm test
        TEST_RESULT=$?
        if [ $TEST_RESULT -ne 0 ]; then
             echo "âŒ Tests Failed!"
             exit 1
        fi
        
        # 2. Run Build
        echo "ğŸ—ï¸ Running Build Check..."
        npm run build
        BUILD_RESULT=$?
        if [ $BUILD_RESULT -ne 0 ]; then
             echo "âŒ Build Failed!"
             exit 1
        fi
    )
    
    # Capture exit code of subshell
    RESULT=$?
    
    if [ $RESULT -ne 0 ]; then
        echo "âŒ Pre-commit checks failed! Commit rejected."
        exit 1
    else
        echo "âœ… All checks (Test & Build) passed!"
    fi
else
    echo "âš ï¸ Warning: $TS_DIR not found. Skipping checks."
fi

exit 0
